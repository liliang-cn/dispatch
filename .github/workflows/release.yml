name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    name: Build and Release
    runs-on: ubuntu-latest
    strategy:
      matrix:
        goos: [linux, windows, darwin]
        goarch: [amd64, arm64]
        exclude:
          - goos: windows
            goarch: arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          mkdir -p dist
          
          # Binary suffix
          EXT=""
          if [ "$GOOS" = "windows" ]; then
            EXT=".exe"
          fi
          
          # Build CLI
          go build -ldflags "-s -w -X main.Version=${{ github.ref_name }}" -o dist/dispatch${EXT} ./cmd/dispatch
          
          # Build Server
          go build -ldflags "-s -w -X main.Version=${{ github.ref_name }}" -o dist/dispatch-server${EXT} ./cmd/dispatch-server

      - name: Archive
        id: archive
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          cd dist
          
          ASSET_NAME="dispatch-${{ github.ref_name }}-${GOOS}-${GOARCH}"
          
          if [ "$GOOS" = "windows" ]; then
            7z a ../${ASSET_NAME}.zip *
            echo "asset_path=${ASSET_NAME}.zip" >> $GITHUB_OUTPUT
            echo "asset_name=${ASSET_NAME}.zip" >> $GITHUB_OUTPUT
          else
            tar -czvf ../${ASSET_NAME}.tar.gz *
            echo "asset_path=${ASSET_NAME}.tar.gz" >> $GITHUB_OUTPUT
            echo "asset_name=${ASSET_NAME}.tar.gz" >> $GITHUB_OUTPUT
          fi

      - name: Upload binaries to release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ steps.archive.outputs.asset_path }}
